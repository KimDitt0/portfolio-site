<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>오싹! 위기 일발! 납량체험의 날!</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Do+Hyeon&display=swap" rel="stylesheet">
<style>
/* --- 기존 CSS 동일 --- */
body { margin:0; padding:0; font-family:'Do Hyeon', sans-serif; background:#0d1b2a; color:#fff; height:100vh; overflow:hidden; position:relative; }
/* ... 기존 CSS 생략 (변경 없음) ... */
</style>
</head>
<body>

<!-- 시작 씬 -->
<div id="startScreen">
  <img src="images/game-logo.png" alt="게임 로고">
  <h1>오싹! 위기 일발! 납량체험의 날!</h1>
  <button id="startGameBtn">게임 시작</button>
</div>

<!-- BGM -->
<div id="bgm-toggle">🔇</div>
<audio id="bgm" src="audio/bgm.mp3" loop></audio>

<!-- 게임 씬 -->
<div id="gameContainer">
  <!-- ... 기존 게임 화면 구조 동일 ... -->
  <div id="zone-display">현재 위치: 1구역</div>
  <div id="character-face"><img src="images/player.png" alt="캐릭터"></div>
  <div id="character-stats">
    <p id="player-attack">공격: 100</p>
    <p id="player-defense">방어: 50</p>
    <p id="player-hp">체력: 300</p>
    <p>상태: 🙂</p>
  </div>
  <div id="event-box">
    <img id="event-img" src="" alt="">
    <div id="monster-health"><div id="monster-health-inner"></div></div>
  </div>
  <div id="items">
    <div id="items-label">아이템</div>
    <div class="item-slot"></div>
    <div class="item-slot"></div>
    <div class="item-slot"></div>
    <div class="item-slot"></div>
  </div>
  <div id="event-log">
    <div id="log"></div>
    <div id="choices"></div>
  </div>
</div>

<!-- 팝업 -->
<div id="popup">
  <img id="popup-img" src="" alt="">
  <p id="popup-text"></p>
  <button id="popup-btn">다시 하기!</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", ()=>{
    const startScreen=document.getElementById("startScreen");
    const startBtn=document.getElementById("startGameBtn");
    const gameContainer=document.getElementById("gameContainer");
    const bgm=document.getElementById("bgm");
    const bgmToggle=document.getElementById("bgm-toggle");
    const log=document.getElementById("log");
    const choices=document.getElementById("choices");
    const eventImg=document.getElementById("event-img");
    const monsterHealthDiv=document.getElementById("monster-health");
    const monsterHealthInner=document.getElementById("monster-health-inner");
    const popup=document.getElementById("popup");
    const popupImg=document.getElementById("popup-img");
    const popupText=document.getElementById("popup-text");
    const popupBtn=document.getElementById("popup-btn");

    let isBGMPlaying=false;
    const characters={player:"images/player.png",npc:"images/npc.png"};
    let player, monster, zoneEvents;
    const possibleEvents=["monster","ally","box"];
    const zones={1:{monsterHp:200,monsterAtk:20},2:{monsterHp:300,monsterAtk:30},3:{monsterHp:400,monsterAtk:40},4:{monsterHp:500,monsterAtk:50},5:{monsterHp:350,monsterAtk:35},6:{monsterHp:250,monsterAtk:25},7:{monsterHp:350,monsterAtk:35},8:{monsterHp:400,monsterAtk:40},9:{monsterHp:450,monsterAtk:45},10:{monsterHp:500,monsterAtk:50}};

    // 클릭 사운드
    function playClickSound(){
        const audio=new Audio("audio/click.mp3");
        audio.volume=0.5;
        audio.play();
    }

    function initGame(){ resetGame(); }

    function writeMessage(text,speaker="npc",imgSrc=null){
        const msgDiv=document.createElement("div");
        msgDiv.className="message "+(speaker==="player"?"player":"");
        const img=document.createElement("img"); img.src=imgSrc||characters[speaker];
        const bubble=document.createElement("div"); bubble.className="bubble"; bubble.innerText=text;
        msgDiv.appendChild(img); msgDiv.appendChild(bubble);
        log.appendChild(msgDiv);
        log.scrollTop=log.scrollHeight;
    }

    function setChoices(options){
        choices.innerHTML="";
        options.forEach(opt=>{
            const btn=document.createElement("button");
            btn.innerText=opt.text;
            btn.onclick=()=>{ playClickSound(); opt.action(); };
            choices.appendChild(btn);
        });
    }

    function updateStats(){
        document.getElementById("player-hp").innerText=`체력: ${player.hp}`;
        monsterHealthInner.style.width=monster.maxHp?(monster.hp/monster.maxHp*100)+"%":"0%";
    }

    function setZoneDisplay(){ document.getElementById("zone-display").innerText=`현재 위치: ${player.zone}구역`; }

    function addItemToSlot(imgSrc){
        const slots=document.querySelectorAll(".item-slot");
        for(const slot of slots){ if(!slot.innerHTML){ const img=document.createElement("img"); img.src=imgSrc; img.style.width="80px"; img.style.height="80px"; slot.appendChild(img); break; } }
    }

    function generateRandomEvents(){
        zoneEvents=[];
        for(let i=0;i<10;i++){ zoneEvents.push({type:possibleEvents[Math.floor(Math.random()*possibleEvents.length)]}); }
    }

    function resetGame(){
        player={hp:300,maxHp:350,attack:100,defense:50,zone:1};
        monster={hp:0,maxHp:0,attack:0};
        clearItems();
        log.innerHTML="";
        generateRandomEvents();
        setZoneDisplay();
        updateStats();
        startZoneEvent();
    }

    function clearItems(){ document.querySelectorAll(".item-slot").forEach(slot=>slot.innerHTML=""); }

    function nextZone(){
        player.hp=Math.max(player.hp-5,0);
        if(player.hp<=0){ triggerFail(); return; }
        player.zone++;
        if(player.zone>10){ triggerClear(); return; }
        startZoneEvent();
    }

    function startZoneEvent(){
        log.innerHTML="";
        setZoneDisplay();
        const event=zoneEvents[player.zone-1];
        monsterHealthDiv.style.display="none";
        eventImg.src=""; eventImg.classList.remove("glow");

        if(event.type==="monster"){
            monster.maxHp=zones[player.zone].monsterHp;
            monster.hp=monster.maxHp;
            monster.attack=zones[player.zone].monsterAtk;
            eventImg.src="images/monster.png";
            monsterHealthDiv.style.display="block";
            updateStats();
            writeMessage(`구역 ${player.zone}에서 유령이 나타났습니다!`,"npc");
            setChoices([{text:"공격",action:attack},{text:"도망",action:flee}]);
        } else if(event.type==="ally"){
            eventImg.src="images/ally.png";
            writeMessage("조우자를 만났습니다! 페로페로~","npc");
            setChoices([
                {text:"대화하기", action:()=>{
                    writeMessage("체력 50 회복!","npc");
                    player.hp=Math.min(player.hp+50,player.maxHp);
                    updateStats();
                    writeMessage("앗싸!","player");
                    setChoices([{text:"다음 구역으로 가기", action:nextZone}]);
                }},
                {text:"그냥 지나가기", action:()=>{
                    player.hp=Math.max(player.hp-5,0);
                    if(player.hp<=0){ triggerFail(); return; }
                    writeMessage("아쉬움을 뒤로 하고 다음 구역으로 이동하였습니다. (체력 -5)","npc");
                    updateStats();
                    setChoices([{text:"다음 구역으로 가기", action:nextZone}]);
                }}
            ]);
        } else if(event.type==="box"){
            eventImg.src="images/box.png"; eventImg.classList.add("glow");
            writeMessage("상자를 발견했습니다!","npc");
            setChoices([
                {text:"열기", action:()=>{
                    eventImg.classList.remove("glow");
                    eventImg.src="images/equipment.png";
                    addItemToSlot("images/equipment.png");
                    writeMessage("상자에서 장비 획득! 공격력+20, 체력+20","npc");
                    player.attack+=20; player.maxHp+=20; player.hp+=20;
                    updateStats();
                    setChoices([{text:"다음 구역으로 가기", action:nextZone}]);
                }},
                {text:"무시", action:()=>{
                    player.hp=Math.max(player.hp-5,0);
                    if(player.hp<=0){ triggerFail(); return; }
                    writeMessage("아쉬움을 뒤로 하고 다음 구역으로 이동하였습니다. (체력 -5)","npc");
                    updateStats();
                    setChoices([{text:"다음 구역으로 가기", action:nextZone}]);
                }}
            ]);
        }
    }

    function attack(){
        if(player.hp<=0) return;
        let dmg=Math.max(player.attack-20,5);
        monster.hp-=dmg; if(monster.hp<0) monster.hp=0;
        writeMessage(`유령에게 ${dmg} 피해를 주었습니다!`,"player");
        updateStats();
        if(monster.hp<=0){
            writeMessage("유령을 처치했습니다!","npc");
            setChoices([{text:"다음 구역으로 가기", action:nextZone}]);
        } else {
            player.hp=Math.max(player.hp-monster.attack,0);
            writeMessage(`유령에게 ${monster.attack} 피해를 받았습니다!`,"npc");
            updateStats();
            if(player.hp<=0){ triggerFail(); }
        }
    }

    function flee(){
        writeMessage("도망쳤습니다.","player");
        player.hp=Math.max(player.hp-5,0);
        if(player.hp<=0){ triggerFail(); return; }
        // 같은 구역에서 다른 이벤트 발생
        zoneEvents[player.zone-1]={type:possibleEvents[Math.floor(Math.random()*possibleEvents.length)]};
        startZoneEvent();
    }

    function triggerClear(){
        popup.style.display="flex";
        popupImg.src="images/clear.gif";
        popupText.innerText="클리어 하셨습니다! 축하드려요 선생님! 🎉";
        popupBtn.innerText="다시 하기!";
        popupBtn.style.background="#4a90e2";
        popupBtn.onclick=()=>{ playClickSound(); popup.style.display="none"; resetGame(); };
    }

    function triggerFail(){
        popup.style.display="flex";
        popupImg.src="images/fail.gif";
        popupText.innerText="패배해버렸어요 선생님.. 🥺";
        popupBtn.innerText="다시 하기!";
        popupBtn.style.background="#e74c3c";
        popupBtn.onclick=()=>{ playClickSound(); popup.style.display="none"; resetGame(); };
    }

    startBtn.onclick=()=>{
        playClickSound();
        startScreen.style.opacity=0;
        setTimeout(()=>{
            startScreen.style.display="none";
            gameContainer.style.display="grid";
            gameContainer.style.opacity=0;
            setTimeout(()=>gameContainer.style.opacity=1,50);
            bgm.play().catch(()=>{});
            bgmToggle.innerText="🔊"; isBGMPlaying=true;
            initGame();
        },500);
    };

    bgmToggle.onclick=()=>{
        playClickSound();
        if(isBGMPlaying){ bgm.pause(); bgmToggle.innerText="🔇"; isBGMPlaying=false; }
        else{ bgm.play().catch(()=>{}); bgmToggle.innerText="🔊"; isBGMPlaying=true; }
    };
});
</script>
</body>
</html>
